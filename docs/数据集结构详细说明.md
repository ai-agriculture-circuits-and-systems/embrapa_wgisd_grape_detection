# WGISD 数据集结构详细说明文档

> **本文档详细说明了 Embrapa WGISD Grape Detection 数据集的结构、文件格式和用途，帮助理解数据集的复杂性和与标准数据集的差异。**

---

## 目录

1. [数据集概述](#数据集概述)
2. [目录结构详解](#目录结构详解)
3. [文件格式说明](#文件格式说明)
4. [与标准数据集的差异](#与标准数据集的差异)
5. [数据标注情况分析](#数据标注情况分析)
6. [建议和注意事项](#建议和注意事项)

---

## 数据集概述

### 基本信息

- **数据集名称**: Embrapa WGISD (Wine Grape Instance Segmentation Dataset)
- **任务类型**: 目标检测、实例分割、葡萄粒计数
- **图像数量**: 300 张
- **葡萄品种**: 5 种（Chardonnay, Cabernet Franc, Cabernet Sauvignon, Sauvignon Blanc, Syrah）
- **标注类型**: 边界框、分割掩码、中心点坐标

### 数据集特点

WGISD 数据集相比标准的水果检测数据集更加复杂，包含：
1. **多种标注格式**: YOLO格式、CSV格式、JSON格式、NPZ格式
2. **多种分辨率**: 原始高分辨率图像和降采样后的图像
3. **多种任务支持**: 检测、分割、计数
4. **额外的资源**: 视频帧、贡献数据、Jupyter notebook

---

## 目录结构详解

### 1. `contrib/berries/` - 贡献的葡萄粒标注

**位置**: `/contrib/berries/`

**内容**: 
- 每张图像对应一个 `{image_name}-berries.txt` 文件
- 共 300 个文件，总计约 187,374 行标注

**文件格式**:
```
1693    701
1717    695
1682    681
```
- **格式**: 制表符分隔（Tab-separated）
- **字段**: `x坐标  y坐标`
- **坐标系统**: 绝对像素坐标（左上角为原点）
- **用途**: 单个葡萄粒的中心点坐标，用于计数任务

**示例文件**:
- `CDY_2015-berries.txt`: 654 行（654 个葡萄粒）
- `CDY_2017-berries.txt`: 384 行（384 个葡萄粒）

**与 `data/origin/train_berries.txt` 的区别**:
- `contrib/berries/`: 每张图像一个文件，格式为 `x y`（制表符分隔）
- `train_berries.txt`: 所有图像合并，格式为 `image_name class_id x y`（空格分隔）

---

### 2. `data/origin/CDY_2015.npz` - 分割掩码文件

**位置**: `/data/origin/*.npz`

**文件数量**: 137 个 .npz 文件

**文件结构**:
```python
{
    'arr_0': numpy.ndarray  # Shape: (height, width, 24)
}
```

**数据格式**:
- **形状**: `(1365, 2048, 24)` - 对应图像 `CDY_2015.jpg` 的尺寸
- **数据类型**: `float64`
- **数值范围**: `[0.0, 1.0]`
- **唯一值**: `[0.0, 1.0]` - 二值掩码

**通道说明**:
- 共 24 个通道
- 每个通道代表一个葡萄实例的分割掩码
- 值 1.0 表示该像素属于该实例，0.0 表示背景

**用途**: 
- 实例分割任务
- 可以转换为 PNG 格式的掩码图像
- 与 `coco_annotations/*_polygons_instances.json` 中的多边形标注对应

**转换方法**:
- 可以合并所有通道（union）生成单一掩码
- 或保留多通道格式用于多实例分割

---

### 3. `data/origin/CDY_2015.txt` - YOLO 格式标注

**位置**: `/data/origin/*.txt`（每个图像对应一个）

**文件格式**:
```
0 0.1116 0.3026 0.0845 0.2271
0 0.5168 0.5084 0.0415 0.0645
0 0.6697 0.4912 0.0386 0.0945
```

**字段说明**:
- **格式**: 空格分隔
- **字段**: `class_id center_x center_y width height`
  - `class_id`: 类别ID（0 = grape）
  - `center_x`: 归一化中心x坐标（0-1）
  - `center_y`: 归一化中心y坐标（0-1）
  - `width`: 归一化宽度（0-1）
  - `height`: 归一化高度（0-1）

**坐标系统**:
- 使用归一化坐标（0-1范围）
- 中心点格式（center_x, center_y）
- 需要转换为绝对像素坐标和左上角格式才能用于标准检测框架

**转换关系**:
- 绝对x = center_x × image_width
- 绝对y = center_y × image_height
- 左上角x = center_x × image_width - (width × image_width) / 2
- 左上角y = center_y × image_height - (height × image_height) / 2

**已转换**: 这些文件已转换为 CSV 格式存储在 `grapes/csv/` 目录

---

### 4. `extra/video_demo_frames/` - 视频演示帧

**位置**: `/extra/video_demo_frames/`

**内容**:
- 500 张视频帧图像
- 文件命名: `frame-00001.jpg`, `frame-00002.jpg`, ...
- 总大小: 约 55MB

**文件格式**:
- JPG 格式
- 文件大小: 140KB - 260KB 不等

**用途**:
- 视频演示和可视化
- 可能用于视频序列的葡萄检测任务
- **注意**: 这些帧可能没有对应的标注文件

**建议**:
- 这些文件是额外的演示资源，不属于核心数据集
- 可以保留在 `extra/` 目录中，但不应包含在标准化的数据集结构中

---

### 5. `original_resolution/` - 原始高分辨率图像

**位置**: `/original_resolution/`

**内容**:
- 300 张原始高分辨率图像
- 所有图像文件（与 `data/origin/` 中的图像对应）

**分辨率对比**:

| 目录 | 分辨率 | 示例 (CDY_2015.jpg) |
|------|--------|---------------------|
| `data/origin/` | 2048×1365 | 降采样后的图像 |
| `original_resolution/` | 5184×3456 | 原始高分辨率图像 |

**分辨率差异**:
- 原始分辨率: **5184×3456** (约 2.5倍)
- 降采样分辨率: **2048×1365**
- 降采样比例: 约 2.53:1

**影响**:
- **标注文件**: 所有标注（YOLO、CSV、JSON）都是基于降采样后的图像（2048×1365）
- **分割掩码**: `.npz` 文件也是基于降采样后的图像尺寸
- **坐标转换**: 如果使用原始分辨率图像，需要按比例缩放标注坐标

**建议**:
- 标准数据集应使用 `data/origin/` 中的降采样图像（与标注对应）
- `original_resolution/` 可以作为额外资源保留，但需要重新标注或坐标转换

---

### 6. `WGISD.ipynb` - Jupyter Notebook

**位置**: `/WGISD.ipynb`

**内容**:
- 53 个单元格（13 个 Markdown，40 个代码）
- 数据集说明文档
- 数据处理和可视化代码

**主要章节**（根据 Markdown 单元格）:
1. 数据集创建原因
2. 数据集结构说明
3. 数据加载和可视化代码
4. 使用示例

**用途**:
- 数据集的使用指南
- 代码示例和教程
- 数据可视化

**建议**:
- 可以保留作为参考文档
- 也可以提取 Markdown 内容到 README 或文档中

---

## 文件格式说明

### 标注文件类型总结

| 文件类型 | 位置 | 格式 | 用途 | 数量 |
|---------|------|------|------|------|
| YOLO标注 | `data/origin/*.txt` | 归一化中心坐标 | 目标检测 | 300 |
| CSV标注 | `grapes/csv/*.csv` | 绝对像素坐标 | 目标检测（已转换） | 300 |
| JSON标注 | `grapes/json/*.json` | COCO格式 | 目标检测（参考） | 300 |
| NPZ掩码 | `data/origin/*.npz` | 多通道二值掩码 | 实例分割 | 137 |
| 中心点坐标 | `contrib/berries/*.txt` | 绝对像素坐标 | 计数/关键点 | 300 |
| 中心点列表 | `data/origin/*_berries.txt` | 空格分隔列表 | 计数任务 | 5 |
| COCO JSON | `annotations/*.json` | COCO格式 | 标准检测框架 | 3 |
| COCO原始 | `coco_annotations/*.json` | COCO格式（原始） | 原始COCO标注 | 4 |

---

## 与标准数据集的差异

### 1. 多分辨率问题

**标准数据集**: 单一分辨率，标注与图像一一对应

**WGISD数据集**: 
- 存在两种分辨率：原始（5184×3456）和降采样（2048×1365）
- 所有标注基于降采样图像
- 需要明确使用哪个分辨率

**影响**:
- 如果使用原始分辨率图像，需要重新标注或坐标转换
- 标准化数据集应统一使用降采样图像

### 2. 多种标注格式并存

**标准数据集**: 通常只有一种主要标注格式（CSV 或 COCO）

**WGISD数据集**:
- YOLO格式（原始）
- CSV格式（已转换）
- JSON格式（每张图像）
- NPZ格式（分割掩码）
- COCO格式（合并的）

**影响**:
- 需要明确主要使用的格式
- 需要保持格式之间的一致性

### 3. 额外的任务支持

**标准数据集**: 通常只支持目标检测

**WGISD数据集**:
- 目标检测（边界框）
- 实例分割（掩码）
- 计数任务（中心点坐标）

**影响**:
- 数据集结构更复杂
- 需要支持多种任务类型

### 4. 贡献数据目录

**标准数据集**: 通常没有 `contrib/` 目录

**WGISD数据集**:
- `contrib/berries/` 包含额外的葡萄粒标注
- 格式与主数据集不同（制表符 vs 空格）

**影响**:
- 需要统一格式或明确说明用途

### 5. 原始COCO标注

**标准数据集**: 通常由脚本生成COCO格式

**WGISD数据集**:
- `coco_annotations/` 包含原始COCO格式文件
- 包含5个类别（按葡萄品种分类）
- 包含边界框和多边形两种格式

**影响**:
- 与标准化后的单类别COCO格式不同
- 需要明确使用哪个版本

---

## 数据标注情况分析

### 标注完整性

| 标注类型 | 图像数量 | 覆盖率 |
|---------|---------|--------|
| 边界框（YOLO/CSV） | 300 | 100% |
| JSON标注 | 300 | 100% |
| 分割掩码（NPZ） | 137 | 45.7% |
| 中心点坐标（contrib） | 300 | 100% |
| 中心点列表（berries.txt） | 300 | 100% |

### 标注一致性检查

**需要验证的问题**:
1. YOLO标注与CSV标注是否一致？
2. 边界框标注与分割掩码是否对应？
3. 中心点坐标与边界框是否一致？
4. 不同格式的标注数量是否匹配？

**建议**:
- 进行标注一致性验证
- 发现不一致时需要决定使用哪个版本

---

## 建议和注意事项

### 1. 数据集标准化建议

#### 当前标准化结构（已完成）
```
grapes/
├── csv/          # CSV格式标注（已转换）
├── json/        # JSON格式标注
├── images/      # 降采样图像（2048×1365）
├── segmentations/  # PNG格式分割掩码（如需要）
└── sets/        # 数据集划分文件
```

#### 需要决定的事项

1. **是否使用原始高分辨率图像？**
   - 如果使用，需要重新标注或坐标转换
   - 建议：保持使用降采样图像（与标注对应）

2. **是否包含分割掩码？**
   - 137个图像有分割掩码（45.7%覆盖率）
   - 建议：转换为PNG格式，放在 `grapes/segmentations/`

3. **如何处理 `contrib/berries/`？**
   - 格式与主数据集不同
   - 建议：统一格式或明确说明为额外资源

4. **是否使用原始COCO标注？**
   - 原始COCO包含5个类别（按品种）
   - 标准化后为1个类别（grape）
   - 建议：使用标准化后的COCO格式

### 2. 标注重新检查建议

由于数据集结构复杂，建议进行以下检查：

1. **标注完整性检查**
   - 验证每张图像是否有对应的标注文件
   - 检查标注文件是否为空或损坏

2. **坐标一致性检查**
   - 验证YOLO标注与CSV标注的一致性
   - 检查边界框是否在图像范围内

3. **格式转换验证**
   - 验证YOLO到CSV的转换是否正确
   - 检查NPZ到PNG的转换是否完整

4. **数据划分验证**
   - 验证train/val/test划分是否合理
   - 检查是否有图像重复或遗漏

### 3. 文档更新建议

1. **README.md 更新**
   - 明确说明使用降采样图像（2048×1365）
   - 说明分割掩码的覆盖率（45.7%）
   - 说明额外资源的位置和用途

2. **创建使用指南**
   - 说明如何加载不同格式的标注
   - 提供坐标转换示例代码
   - 说明如何处理缺失的分割掩码

### 4. 目录整理建议

建议的最终目录结构：

```
embrapa_wgisd_grape_detection/
├── grapes/                    # 标准化数据（主要使用）
│   ├── csv/                  # CSV标注
│   ├── json/                 # JSON标注
│   ├── images/               # 降采样图像（2048×1365）
│   ├── segmentations/        # PNG分割掩码（可选）
│   ├── labelmap.json
│   └── sets/                 # 数据集划分
├── annotations/               # COCO格式（标准化后）
├── data/
│   └── origin/               # 原始数据（保留）
│       ├── *.jpg             # 降采样图像
│       ├── *.txt             # YOLO标注
│       ├── *.json            # JSON标注
│       ├── *.npz             # 分割掩码
│       └── *_berries.txt     # 中心点列表
├── original_resolution/       # 原始高分辨率图像（额外资源）
├── contrib/                   # 贡献数据（额外资源）
│   └── berries/              # 葡萄粒标注
├── extra/                     # 额外资源
│   └── video_demo_frames/    # 视频帧
├── coco_annotations/          # 原始COCO标注（保留参考）
├── scripts/                   # 转换脚本
├── docs/                      # 文档（本文件）
├── LICENSE
├── README.md
└── requirements.txt
```

---

## 总结

WGISD 数据集相比标准数据集更加复杂，主要体现在：

1. **多分辨率**: 原始和降采样图像并存
2. **多格式**: YOLO、CSV、JSON、NPZ、COCO多种格式
3. **多任务**: 检测、分割、计数多种任务支持
4. **额外资源**: 视频帧、贡献数据、高分辨率图像

**建议的标准化方向**:
- 使用降采样图像（2048×1365）作为主要数据
- 统一使用CSV和COCO格式作为主要标注格式
- 将分割掩码转换为PNG格式（如需要）
- 将额外资源明确标记为可选资源

**下一步行动**:
1. 决定是否重新标注或转换原始高分辨率图像
2. 验证标注的一致性和完整性
3. 统一标注格式
4. 更新文档说明

---

**文档创建时间**: 2025-12-10  
**数据集版本**: V1.0.0  
**最后更新**: 2025-12-10

